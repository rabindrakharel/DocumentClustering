WITH CTE1 AS (
SELECT
fc_type,warehouse_id,shift,week(metric_date) as week,weekday(metric_date)+2 as day, avg(capped_bl) as tcap,avg(uncapped_bl) as ucap
where metric_date between  
date_add(CURDATE(), interval - WEEKDAY(CURDATE())-15 day) and  
date_add(CURDATE(), interval - WEEKDAY(CURDATE())-2 day)
GROUP BY 1,2,3,4,5
),
CTE2 AS (
SELECT fc_type,warehouse_id,shift,week, day, tcap, ucap, 
CASE WHEN ucap > = 0.25 THEN 1
ELSE 0
END flag
FROM CTE1
),
