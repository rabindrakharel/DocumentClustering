WITH CTE1 AS (
SELECT
fc_type,warehouse_id,shift,date_part(w,metric_date) as week,date_part(dow,metric_date)+1 as day, avg(capped_days_of_backlog) as tcap,avg(uncapped_days_of_backlog) as ucap
FROM ppt_sandbox.tcap_hours_backlog 
where metric_date  BETWEEN 
(DATE_TRUNC('week', DATEADD(day, -14, GETDATE())) - INTERVAL '1 days') 
AND  
(DATE_TRUNC('week', DATEADD(day, -1, GETDATE())) - INTERVAL '2 day' )
GROUP BY 1,2,3,4,5  
),
CTE2 AS (
SELECT fc_type,warehouse_id,shift,week, day, tcap, ucap, 
CASE WHEN ucap <= 0.25 THEN 1
ELSE 0
END threshold_flag
FROM CTE1
)
SELECT fc_type,shift,warehouse_id,week, day, tcap, ucap,threshold_flag, (avg(tcap) over (partition by warehouse_id,shift,day)) as average_tcap
  FROM CTE2
 ORDER BY 1 asc, 2 asc, 3 asc, 4 asc, 5 asc;
